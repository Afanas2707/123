databaseChangeLog:
  - changeSet:
      id: add-mode-column-to-chat_messages
      author: Alexey Afanasievskiy
      changes:
        - addColumn:
            tableName: chat_messages
            columns:
              - column:
                  name: mode
                  type: VARCHAR(255)
  - changeSet:
      id: modify-llm_request_log-add-llm-fields
      author: Alexey Afanasievskiy
      changes:
        - dropColumn:
            tableName: llm_request_log
            columns:
              - column:
                  name: http_method
              - column:
                  name: request_path
              - column:
                  name: http_status
              - column:
                  name: username
              - column:
                  name: request_duration_ms
        - renameColumn:
            tableName: llm_request_log
            oldColumnName: request_body
            newColumnName: prompt
        - renameColumn:
            tableName: llm_request_log
            oldColumnName: response_body
            newColumnName: response
        - addColumn:
            tableName: llm_request_log
            columns:
              - column:
                  name: prompt_tokens
                  type: BIGINT
              - column:
                  name: completion_tokens
                  type: BIGINT
              - column:
                  name: total_tokens
                  type: BIGINT
              - column:
                  name: response_time_ms
                  type: BIGINT
              - column:
                  name: model_name
                  type: VARCHAR(255)
  - changeSet:
      id: modify-llm_request_log-add-fk-to-chat_messages
      author: Alexey Afanasievskiy
      changes:
        - addColumn:
            tableName: llm_request_log
            columns:
              - column:
                  name: chat_message_id
                  type: uuid
        - addForeignKeyConstraint:
            baseColumnNames: chat_message_id
            baseTableName: llm_request_log
            constraintName: fk_llm_log_chat_message
            onDelete: SET NULL
            onUpdate: CASCADE
            referencedColumnNames: id
            referencedTableName: chat_messages
            deferrable: true
            initiallyDeferred: true
        - addForeignKeyConstraint:
            baseColumnNames: session_id
            baseTableName: chat_messages
            constraintName: fk_chat_session_user
            onDelete: SET NULL
            onUpdate: CASCADE
            referencedColumnNames: id
            referencedTableName: user_chat_sessions
            deferrable: true
            initiallyDeferred: true